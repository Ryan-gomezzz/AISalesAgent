service: aisalesagent

provider:
  name: aws
  runtime: nodejs18.x
  region: ${opt:region, 'ap-south-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  environment:
    NODE_ENV: production
    NODE_PATH: /var/task/backend/node_modules:/var/task/backend/dist
    FRONTEND_KEY: ${env:FRONTEND_KEY, 'dev-key'}
    BEDROCK_MODEL: ${env:BEDROCK_MODEL, 'anthropic.claude-v2'}
    MOCK_BEDROCK: ${env:MOCK_BEDROCK, 'false'}
    S3_BUCKET_NAME: ${self:custom.s3Bucket}
    DYNAMODB_TABLE: ${self:custom.dynamoDBTable}
    POLLY_VOICE: ${env:POLLY_VOICE, 'Joanna'}
    TRANSCRIBE_ROLE_ARN: ${self:custom.transcribeRoleArn}
    COGNITIVE_API_URL: ${env:COGNITIVE_API_URL, ''}
    COGNITIVE_API_KEY: ${env:COGNITIVE_API_KEY, ''}
    USE_REKOGNITION_FALLBACK: ${env:USE_REKOGNITION_FALLBACK, 'true'}
    CORS_ORIGIN: ${env:CORS_ORIGIN, '*'}
  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - bedrock:InvokeModel
            - bedrock:InvokeModelWithResponseStream
          Resource: '*'
        - Effect: Allow
          Action:
            - polly:SynthesizeSpeech
          Resource: '*'
        - Effect: Allow
          Action:
            - transcribe:StartTranscriptionJob
            - transcribe:GetTranscriptionJob
            - transcribe:ListTranscriptionJobs
          Resource: '*'
        - Effect: Allow
          Action:
            - rekognition:DetectFaces
            - rekognition:DetectLabels
          Resource: '*'
        - Effect: Allow
          Action:
            - s3:PutObject
            - s3:GetObject
            - s3:DeleteObject
            - s3:PutObjectAcl
          Resource:
            - arn:aws:s3:::${self:custom.s3Bucket}/*
        - Effect: Allow
          Action:
            - s3:ListBucket
          Resource:
            - arn:aws:s3:::${self:custom.s3Bucket}
        - Effect: Allow
          Action:
            - dynamodb:PutItem
            - dynamodb:GetItem
            - dynamodb:Query
            - dynamodb:Scan
            - dynamodb:UpdateItem
            - dynamodb:DeleteItem
          Resource:
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDBTable}
            - arn:aws:dynamodb:${self:provider.region}:*:table/${self:custom.dynamoDBTable}/index/*

custom:
  s3Bucket: ${self:service}-assets-${self:provider.stage}
  dynamoDBTable: ${self:service}-conversations-${self:provider.stage}
  transcribeRoleArn: arn:aws:iam::${aws:accountId}:role/${self:service}-transcribe-role-${self:provider.stage}


functions:
  api:
    handler: index.handler
    runtime: nodejs18.x
    events:
      - http:
          path: /api/{proxy+}
          method: ANY
          cors:
            origin: '*'
            headers:
              - Content-Type
              - x-frontend-key
              - X-Frontend-Key
              - Authorization
            allowCredentials: true

resources:
  Resources:
    # S3 Bucket for audio assets
    AssetsBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${self:custom.s3Bucket}
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteOldAssets
              Status: Enabled
              ExpirationInDays: 7
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true

    # DynamoDB Table for conversations
    ConversationsTable:
      Type: AWS::DynamoDB::Table
      Properties:
        TableName: ${self:custom.dynamoDBTable}
        AttributeDefinitions:
          - AttributeName: sessionId
            AttributeType: S
          - AttributeName: messageId
            AttributeType: S
        KeySchema:
          - AttributeName: sessionId
            KeyType: HASH
          - AttributeName: messageId
            KeyType: RANGE
        BillingMode: PAY_PER_REQUEST
        TimeToLiveSpecification:
          AttributeName: ttl
          Enabled: true
        GlobalSecondaryIndexes:
          - IndexName: timestamp-index
            KeySchema:
              - AttributeName: sessionId
                KeyType: HASH
              - AttributeName: messageId
                KeyType: RANGE
            Projection:
              ProjectionType: ALL

    # IAM Role for Transcribe
    TranscribeRole:
      Type: AWS::IAM::Role
      Properties:
        RoleName: ${self:service}-transcribe-role-${self:provider.stage}
        AssumeRolePolicyDocument:
          Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Principal:
                Service: transcribe.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: TranscribeS3Access
            PolicyDocument:
              Version: '2012-10-17'
              Statement:
                - Effect: Allow
                  Action:
                    - s3:GetObject
                    - s3:PutObject
                  Resource:
                    - arn:aws:s3:::${self:custom.s3Bucket}/*

  Outputs:
    ApiGatewayRestApiId:
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:provider.stage}-ApiGatewayRestApiId
    ApiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
          - ApiGatewayRestApi
          - RootResourceId
      Export:
        Name: ${self:provider.stage}-ApiGatewayRestApiRootResourceId
    ServiceEndpoint:
      Description: 'API Gateway endpoint URL'
      Value:
        Fn::Join:
          - ''
          - - https://
            - Ref: ApiGatewayRestApi
            - .execute-api.
            - ${self:provider.region}
            - .amazonaws.com/
            - ${self:provider.stage}
    S3BucketName:
      Value: ${self:custom.s3Bucket}
      Export:
        Name: ${self:provider.stage}-S3BucketName
    DynamoDBTableName:
      Value: ${self:custom.dynamoDBTable}
      Export:
        Name: ${self:provider.stage}-DynamoDBTableName

plugins:
  - serverless-offline

package:
  patterns:
    - 'index.js'
    - 'handlers/**'
    - 'services/**'
    - 'utils/**'
    - 'backend/node_modules/**'
    - 'prompts/**'
    - 'backend/prompts/**'
    - '!backend/src/**'
    - '!backend/dist/**'
    - '!frontend/**'
    - '!infra/**'
    - '!demo/**'
    - '!scripts/**'
    - '!*.md'
    - '!.git/**'
    - '!.github/**'
    - '!node_modules/**'
  excludeDevDependencies: true
  individually: false

